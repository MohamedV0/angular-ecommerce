<!-- Refactored Checkout Page - Clean Component Architecture -->
<div class="min-h-screen">

  <!-- Page Header -->
  <div class="border-b border-surface shadow-sm">
    <div class="container mx-auto px-4 py-6">
      <div class="flex items-center gap-3">
        <i class="pi pi-credit-card text-2xl text-primary" aria-hidden="true"></i>
        <h1 class="text-2xl font-bold text-color">
          {{ 'CHECKOUT.TITLE' | translate }}
        </h1>
      </div>
    </div>
  </div>

  <div class="container mx-auto px-4 py-8">

    <!-- Loading State -->
    @if (loading()) {
      <div class="max-w-4xl mx-auto">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <div>
            <p-card>
              <div class="space-y-4">
                <p-skeleton width="60%" height="1.5rem"></p-skeleton>
                <p-skeleton width="100%" height="3rem"></p-skeleton>
                <p-skeleton width="100%" height="3rem"></p-skeleton>
                <p-skeleton width="80%" height="3rem"></p-skeleton>
              </div>
            </p-card>
          </div>
          <div>
            <p-card>
              <div class="space-y-4">
                <p-skeleton width="50%" height="1.5rem"></p-skeleton>
                <p-skeleton width="100%" height="4rem"></p-skeleton>
                <p-skeleton width="100%" height="2rem"></p-skeleton>
              </div>
            </p-card>
          </div>
        </div>
      </div>
    }

    <!-- Error State -->
    @else if (error()) {
      <div class="max-w-2xl mx-auto text-center">
        
        <!-- Error Icon and Header -->
        <div class="mb-8">
          <div class="w-24 h-24 bg-red-500 rounded-full flex items-center justify-center mx-auto mb-6">
            <i class="pi pi-exclamation-triangle text-4xl text-white"></i>
          </div>
          <h1 class="text-3xl font-bold text-color mb-4">
            {{ 'CHECKOUT.ERROR_TITLE' | translate }}
          </h1>
          <p class="text-lg text-muted-color">
            {{ 'CHECKOUT.ERROR_MESSAGE' | translate }}
          </p>
        </div>

        <!-- Error Details Card -->
        <p-card class="mb-8 shadow-sm">
          <ng-template pTemplate="header">
            <div class="flex items-center gap-3 p-4 bg-emphasis">
              <i class="pi pi-info-circle text-red-600"></i>
              <h3 class="font-semibold text-color">{{ 'CHECKOUT.ERROR_DETAILS' | translate }}</h3>
            </div>
          </ng-template>
          
          <div class="text-left">
            <p-message 
              severity="error" 
              [text]="error()"
              class="text-left">
            </p-message>
          </div>
        </p-card>

        <!-- Action Buttons -->
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <p-button 
            [label]="'CHECKOUT.TRY_AGAIN' | translate"
            icon="pi pi-refresh"
            (click)="retryCheckout()"
            severity="primary"
            size="large">
          </p-button>
          <p-button 
            [label]="'CHECKOUT.BACK_TO_CART' | translate"
            icon="pi pi-arrow-left"
            routerLink="/cart"
            severity="secondary"
            [outlined]="true"
            size="large">
          </p-button>
        </div>

      </div>
    }

    <!-- Main Checkout Form - Refactored with Sub-components -->
    @else {
      <div class="max-w-6xl mx-auto">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          
          <!-- Left Column: Address Selection & Payment -->
          <div class="space-y-6">
            
            <!-- Address Selector Component -->
            <app-address-selector
              [isDisabled]="isProcessing()"
              (selectionChange)="onAddressSelectionChange($event)"
              (addressSelected)="onAddressSelected($event)">
            </app-address-selector>

            <!-- Shipping Address Form (Only shown when adding new address) -->
            @if (showAddressForm()) {
              <app-checkout-form
                [isProcessing]="isProcessing()"
                (formValidChange)="onFormValidChange($event)"
                (formValueChange)="onFormValueChange($event)">
              </app-checkout-form>
            }

            <!-- Payment Method Selector Component -->
            <app-payment-method-selector
              [selectedPaymentMethod]="paymentMethod()"
              [isDisabled]="isProcessing()"
              (paymentMethodChange)="onPaymentMethodChange($event)">
            </app-payment-method-selector>
          </div>

          <!-- Right Column: Order Summary Component -->
          <app-order-summary
            [cartItems]="cartItems()"
            [cartSummary]="cartSummary()"
            [isProcessing]="isProcessing()">
            
            <!-- Place Order Button (projected content) -->
            <div orderActions>
              <p-button 
                [label]="submitButtonLabel()"
                severity="primary"
                icon="pi pi-check"
                iconPos="right"
                [disabled]="!canSubmit()"
                [loading]="isProcessing()"
                (click)="onSubmit()"
                class="w-full"
                [attr.aria-label]="submitButtonLabel()">
              </p-button>
            </div>
          </app-order-summary>

        </div>
      </div>
    }

  </div>
</div>

